pipeline {
    agent any

    environment {
        GITHUB_CREDENTIALS    = credentials('github-token')
        NEXUS_DOCKER_CRED     = credentials('nexus-docker-credentials')
        NEXUS_REGISTRY        = 'localhost:5000'
        REPOSITORY_NAME       = 'docker-hosted'
        // Construct the full image name
        IMAGE_NAME            = "${NEXUS_REGISTRY}/${REPOSITORY_NAME}/static-api:latest"
    }

    stages {
        stage('Clone Repository') {
            steps {
                git branch: 'main', credentialsId: 'github-token', url: 'https://github.com/SelimRiahi/test-jenk.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dir('test') {
                        // Build and tag the image using the full image name.
                        bat "docker build -t %NEXUS_REGISTRY%/%REPOSITORY_NAME%/static-api:latest ."
                    }
                }
            }
        }

        stage('Run Docker Container') {
            steps {
                script {
                    // Remove any existing container named "static-api"
                    bat '''
                        docker rm -f static-api || echo "No existing container to remove"
                    '''
                    // Run the new container
                    bat "docker run -d -p 3000:3000 --name static-api %NEXUS_REGISTRY%/%REPOSITORY_NAME%/static-api:latest"
                }
            }
        }

        stage('Push Docker Image to Nexus') {
            steps {
                script {
                    // Login only to the registry host, not the full repository path.
                    bat "docker login %NEXUS_REGISTRY% -u %NEXUS_DOCKER_CRED_USR% -p %NEXUS_DOCKER_CRED_PSW%"
                    // Push the image to Nexus
                    bat "docker push %NEXUS_REGISTRY%/%REPOSITORY_NAME%/static-api:latest"
                }
            }
        }
    }
}

